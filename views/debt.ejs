<% include ./partials/header %>

<style>
    @media screen and (max-width: 640px) {
        body {
        overflow-x: hidden;
        }
    }
</style>
<%
   %>
  
<div id='paMobileHeader'>
<div class='container'>
        <h3 id='welcome'></h3><div class='pull-right' id='date'></div>
        <h1 id='welcome'>Debt Tracker</h1>
        <hr>
    </div>
</div>

<div class='container'>
    <div class='row' id='mobile-card'>
        <div class='col-lg-3 col-sm-12'>
        </div>
    </div>
</div>
<br>
<div class='container'>

    


<div class='row'>
<div class='col-lg-3 col-sm-12' id='mobile-card'>
    <div class='chiclet'>
        <div class="panel panel-default panel-default">
            <div class="panel-heading"><strong>Debt Snapshot</strong>
                <a href="/startingDebt/new" class='pull-right' id='hiddenButton' data-toggle="modal" data-target="#addstartingDebt">Add Starting Debt</a>
            </div>
                <table class="table">
                    <tr>
                        <td>Starting Debt</td>
                            <td class='td-right'>
                                
                                    <% var totalDebt = 0 %>
                                    <% startingDebt.forEach(function(startingDebt){ %>
                                    <% if(currentUser.username === startingDebt.author.username){ %>
                                    <span id='dollarSign'>$</span>
                                <span class='table-number'>
                                    <% totalDebt = totalDebt + startingDebt.amount %>
                                    <a href="/startingDebt/<%= startingDebt._id %>/edit" data-toggle="modal" data-target="#editstartingDebt" id='startingBalance'><%= totalDebt %></a>
                                    <% } %>
                                    <% }) %>
                                </span>
                            </td>
                    </tr>
                    <tr>
                        <td>Total Debt</td>
                        <td class='td-right'><span id='dollarSign'>$</span><div class='table-number' id="totalDebt">0.00</div></td>
                    </tr>  
                    <tr>
                        <td>Paid Off</td>
                        <td class='td-right'><span id='dollarSign'>$</span><div class='table-number' id="paidOff">0.00</div></td>
                    </tr>
                    <tr>
                        <td> % Paid Off</td>
                        <td class='td-right'><span id="%paidOff">0.00</span> %</td>
                    </tr>
                </table>
            </div>
        </div>
                    <div class='chiclet'>
                <div class="panel panel-default">
                    <div class="panel-heading"><strong>Balances</strong></div>
                        <table class="table">
                            <tr>
                                <% var totalCredit = 0 %>
                                <% debt.forEach(function(debt){ %>
                                        <% if((currentUser.username === debt.author.username  || currentUser.username === debt.authUser) && debt.type === "Credit Card"){ %>
                                        <% totalCredit = totalCredit + debt.amount %>
                                        <% } %>
                                        <% }) %>
                                <td><a href="#" id='credit'>Credit Cards</a></td>
                                <td class='td-right'><span id='dollarSign'>$</span><span class='table-number' id='totalCredit'><%= totalCredit.toFixed(2) %></span></td>
                            </tr>
                            <tr>
                                <% var totalLoan = 0 %>
                                <% debt.forEach(function(debt){ %>
                                        <% if((currentUser.username === debt.author.username  || currentUser.username === debt.authUser) && debt.type === "Loan"){ %>
                                        <% totalLoan = totalLoan + debt.amount %>
                                        <% } %>
                                        <% }) %>
                                <td><a href="#" id='loan'>Loans</a></td>
                                <td class='td-right'><span id='dollarSign'>$</span><span class='table-number' id='totalLoan'><%= totalLoan.toFixed(2) %></span></td>
                            </tr>
                            <tr>
                                <% var totalSL = 0 %>
                                <% debt.forEach(function(debt){ %>
                                        <% if((currentUser.username === debt.author.username  || currentUser.username === debt.authUser) && debt.type === "Student Loan"){ %>
                                        <% totalSL = totalSL + debt.amount %>
                                        <% } %>
                                        <% }) %>
                                <td><a href="#" id='SL'>Student Loans</a></td>
                                <td class='td-right'><span id='dollarSign'>$</span><span class='table-number' id='totalSL'><%= totalSL.toFixed(2) %></span></td>
                            </tr>                            
                            <tr>
                                <% var totalBill = 0 %>
                                <% debt.forEach(function(debt){ %>
                                        <% if((currentUser.username === debt.author.username  || currentUser.username === debt.authUser) && debt.type === "Bill"){ %>
                                        <% totalBill = totalBill + debt.amount %>
                                        <% } %>
                                        <% }) %>
                                <td><a href="#" id='bill'>Bills</a></td>
                                <td class='td-right'><span id='dollarSign'>$</span><span class='table-number' id='totalBill'><%= totalBill.toFixed(2) %></span></td>
                            </tr>
                            <tr>
                                <% var totalOther = 0 %>
                                <% debt.forEach(function(debt){ %>
                                        <% if((currentUser.username === debt.author.username  || currentUser.username === debt.authUser) && debt.type === "Other"){ %>
                                        <% totalOther = totalOther + debt.amount %>
                                        <% } %>
                                        <% }) %>
                                <td><a href="#" id='other'>Other</a></td>
                                <td class='td-right'><span id='dollarSign'>$</span><span class='table-number' id='totalOther'><%= totalOther.toFixed(2) %></span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            <div class='panel' id="outerChart">
                <div class="panel-heading"><strong>Payoff Chart</strong></div>
                <br>
                    <div id='chartOutline'>
                        <div id='chartLine'><div id='percent'></div>
                            <div id='chart'>
                        </div>
                    </div>
                </div>
    
            </div>
        </div>


<div class='col-lg-9 col-sm-12' id='mobile-card'>


<div class='chiclet'>
    <div class="panel panel-default panel-danger">
        <div class="panel-heading"><strong>Debts</strong>
            <a href="/debt/new" class='pull-right' id='hiddenButton' data-toggle="modal" data-target="#addDebt">Add Debt</a></div>
        </div>
            <table class="table sortable" id="debts">
                <thead>
                    <tr>
                        <th id='payeeDebt'>Payee</th>
                        <th id='type'>Type</th>
                        <th id='amount'>Amount</th>
                        <th id='interestRate'>%</th>
                        <th id='monthlyPayment'>Payment</th>
                        <th id='website'>Website</th>
                        <th id='trash'></th>
                    </tr>
                </thead>
                <tbody>
                    <% debt.forEach(function(debt){ %>
                        <% if(debt.amount > 0){ %>
                        <tr>
                            <% if(currentUser.username === debt.author.username){ %>
                                <td id='payeeDebt'>
                                    <a href="/debt/<%= debt._id %>/edit" data-toggle="modal" data-target="#editDebt"><%= debt.itemLabel %></a></span></td>
                                <td id='type'><%= debt.type %></td>
                                <td id='amount'><span class='b'><%= debt.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); %></span></td>
                                <td id='interestRate'><%= debt.interestRate.toFixed(3)%>%</td>
                                <td id='monthlyPayment'><%= debt.monthlyPayment.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); %></td>
                                <td id='website'><a href="<%= debt.website %>" target="_blank" class="btn btn-primary btn-xs" id='goButton'>Go</a></td>
                                <td id='delete'>
                                <form action="/debt/<%= debt._id %>?_method=DELETE" method="POST" class="delete-form">
                                    <button id='deleteButton'><span class="glyphicon glyphicon-trash" aria-hidden="true"></button>
                                </form>
                                </td>
                            <% } %>
                        <% } %>
                    <% }) %>
                    </tr>
                </tbody>
            </table>
        </div>


<div class='chiclet main-table' id='paid-off'>
    <div class="panel panel-default panel-danger">
        <div class="panel-heading"><strong>Paid Off Debts</strong>
        </div>
            <table class="table" id="paid-off-debts">
                <thead>
                    <tr>
                        <th id='payeeDebt'>Payee</th>
                        <th id='type'>Type</th>
                        <th id='amount'>Amount</th>
                        <th id='interestRate'>%</th>
                        <th id='monthlyPayment'>Payment</th>
                        <th id='website'>Website</th>
                        <th id='trash'></th>
                    </tr>
                </thead>
                <tbody>
                    <% debt.forEach(function(debt){ %>
                    <tr>
                        <% if(currentUser.username === debt.author.username && debt.amount < 1){ %>
                            <td id='payee'>
                                <a href="/debt/<%= debt._id %>/edit" data-toggle="modal" data-target="#editDebt"><%= debt.itemLabel %></a></span></td>
                            <td id='type'><%= debt.type %></td>
                            <td id='amount'><span class='b'><%= debt.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); %></span></td>
                            <td id='interestRate'><%= debt.interestRate.toFixed(3)%>%</td>
                            <td id='monthlyPayment'><%= debt.monthlyPayment.toLocaleString('en-US', { style: 'currency', currency: 'USD' }); %></td>
                            <td id='website'><a href="<%= debt.website %>" target="_blank" class="btn btn-primary btn-xs" id='goButton'>Go</a></td>
                            <td>
                            <form action="/debt/<%= debt._id %>?_method=DELETE" method="POST" class="delete-form">
                                <button id='deleteButton'><span class="glyphicon glyphicon-trash" aria-hidden="true"></button>
                            </form>
                            </td>
                        <% } %>
                    <% }) %>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
</div>


</div>
<div class='chiclet'>
    <div id='snowball'><%
        var i = 0
        var f = 0
        var c = 0
        var u = 0
        var q = 0
        var k = 0
        var o = 0
        var r = a
        var add = 0
        var year = 0
        var ray = new Array();
        var prevPay = new Array();
        var remainder = new Array();
        var prevMin = [0];
        
        debt.forEach(function(debt){
            if(debt.amount > 0){
                if(currentUser.username === debt.author.username){
                    i++
                }
            }
        }) %>
        
        <div class="panel-heading" id='snowballPanel'><strong>Debt Snowball  (<%= i %>)</strong></div>
            <table><%
                var a = [];
                var interestA = 0;
                debt.forEach(function(debt){
                    if(debt.amount > 0){
                        a.push({
                            amount: debt.amount, 
                            label: debt.itemLabel,
                            interest: debt.interestRate,
                            minimum: debt.monthlyPayment
                        });
                    }
                })
                a.sort(function(a, b){
                    return a.amount == b.amount ? 0 : +(a.amount > b.amount) || -1;
                    }); %>
                <table class='test'>
                    <table class='snowball'>
                        <tr>
                            <th class='snowball-header snowball-head'>
                            </th>
                        </tr>  
                        <tbody id='months'>
                        </tbody>
                    </table>
                    <% for(x = 0; x < a.length; x++){ %>

                    <table class='snowball'>
                        <tr>
                            <th class='snowball-header snowball-head'>
                                <%= a[x].label %>
                            </th>
                        </tr>  
                           
                            <% var b = Number(a[x].amount),
                               debtAmount = Number(b.toFixed(2)),
                               paymentAmount = Number(a[x].minimum),
                               interestRate = a[x].interest * .01,
                               extraPayment = 300,
                               numberOfPayments = 12;
                               
                            function getSum(total, num) {
                              return total + num;
                            }
                            
                            function interestCalculate(debt) {
                                if (interestRate > 0){
                                    calcInterest = ((interestRate/365) * debt) * 30;
                                    var interestA = calcInterest;
                                } else {
                                    var interestA = 0;
                                }
                            }

                            function snowballCalculate(){
                                add = remainder[remainder.length - 1];
                                var w = Number(add)
                                for(var p = 1; p < debtAmount.toFixed(2); p++){ %><tr><td class = 'snowballTD'><%
                                if (interestRate > 0){
                                    calcInterest = (debtAmount * (interestRate/365)) * 30;
                                    var interestA = calcInterest;
                                } else {
                                    var interestA = 0;
                                }
                                    var oldRay = ray[ray.length - 1] - 1;
                                    if (oldRay >= p && debtAmount >= paymentAmount){  
                                        if (oldRay > p){
                                            debtAmount = (debtAmount + interestA) - paymentAmount%>
                                            $<%= paymentAmount.toFixed(2) %><% 
                                        } else {
                                            var n = prevMin[prevMin.length - 2]
                                            o = w + n + paymentAmount
                                            debtAmount = (debtAmount + interestA) - o %>
                                            $<%= o.toFixed(2) %><%
                                        }
                                    } else if (oldRay < p && debtAmount > paymentAmount && (paymentAmount * 2) < debtAmount && (debtAmount - (paymentAmount + extraPayment + prevMin[prevMin.length -1])) > 0){
                                        var d = paymentAmount + extraPayment + prevMin[prevMin.length - 1]
                                        debtAmount = (debtAmount + interestA) - d %>
                                        $<%= d.toFixed(2) %><%
                                    } else { 
				                        q = (paymentAmount + extraPayment) - (debtAmount + interestA);
                                        remainder.push(q.toFixed(2));
                                        prevPay.push(paymentAmount);
                                        u = prevPay.reduce(getSum)
                                        prevMin.push(u)
                                        paymentAmount = debtAmount + interestA; 
                                        debtAmount = (debtAmount + interestA) - paymentAmount %>
                                        $<%= paymentAmount.toFixed(2) %><%
                                    }
                                } ray.push(p);  
                            } snowballCalculate(); %>
                        </tr>
                    </table>
                <% } %>
                <table class='snowball' style="display: none;">
                <tr>
                            <th class='snowball-header snowball-head'>
                                Payoff
                            </th>
                        </tr>  
                        <tr>
                            <td class = 'snowball-head'>
                               Calendar
                            </td>
                        </tr>                           
                        <tr>
                            <td  class='snowball-head' id='head'>
                                By Month
                            </td>
                        </tr id='head'><tbody id='orMonths'> <%
                        var month = new Array();
                            month[0] = "Jan";
                            month[1] = "Feb";
                            month[2] = "Mar";
                            month[3] = "Apr";
                            month[4] = "May";
                            month[5] = "Jun";
                            month[6] = "Jul";
                            month[7] = "Aug";
                            month[8] = "Sep";
                            month[9] = "Oct";
                            month[10] = "Nov";
                            month[11] = "Dec";
                            
                        function months() {
                            var d = new Date();
                            r = month[d.getMonth()]; 
                            year = 1900 + d.getYear();
                        }
                            
                        months();
                        var a = month.indexOf(r)
                        console.log(a)
                        var z = ray[ray.length - 1]
                        for(i = a; i < z; i++){ 
                            if(month[i%month.length] === "Jan"){
                                year = year + 1 %>
                                <tr><td><%= month[i%month.length] %> <%= year %></td></tr>
                            <% } else { %>
                                <tr><td><%= month[i%month.length] %> <%= year %></td></tr>
                            <% } 
                        } %>
                </tbody>
            </table>
        </table>
    </div>
</div>
</div>

<script>

 
</script>

<% include ./partials/footer %>

<!--NEW MODAL-->

<div class="modal fade" id="addDebt" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-body"></div>
    </div>
</div>
</div>

<div class="modal fade" id="addstartingDebt" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-body"></div>
    </div>
</div>
</div>

<!--EDIT MODAL-->
<div class="modal fade" id="editDebt" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-body"></div>
    </div>
</div>
</div>

<div class="modal fade" id="editstartingDebt" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-body"></div>
    </div>
</div>
</div>

<script type="text/javascript" src='/js/debt.js'>
</script>
